<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>
        let books = [];
        let continueLoop = true;
        
        while (continueLoop) {
            let choice = prompt("Enter your choice:\n1. Add books\n2. Borrow books\n3. Return books\n4. Display library report");
            
            switch (choice) {
                case "1":
                    addBook();
                    break

                case "2":
                    borrowBook()
                    break

                case "3":
                    returnBook()
                    break

                case "4":
                    showReport()
                    break    

                default:
                    alert("Invalid choice");
            }
            
            if (!confirm("Do you want to perform another operation?")) {
                continueLoop = false;
                alert("Thank you for using the library management system!");
            }
        }

        function addBook() {
            let bookName = prompt("Enter the title of the book:");
                if (bookName === null || bookName === "") {
                    alert("Book name cannot be empty");
                    return;
                } 
                else if (books.some(book => book.bookName.toLowerCase() === bookName.toLowerCase())) {
                    alert("Book already exists");
                    return
                }
                let authorName = prompt("Enter the author of the book:");
                if (authorName === null || authorName === "") {
                    alert("Author name cannot be empty")
                    return;
                }
                let availableCopies = prompt("Enter the number of copies available:");
                if (availableCopies === null || availableCopies === "") {
                    alert("Available copies cannot be empty");
                    return
                }
                availableCopies = parseInt(availableCopies);
                if (isNaN(availableCopies) || availableCopies < 0) {
                    alert("Available copies must be a valid non-negative number");
                    return;
                }
                let borrowedCopies = prompt("Enter the number of copies borrowed:");
                if (borrowedCopies === null || borrowedCopies === "") {
                    alert("Borrowed copies cannot be empty");
                    return
                }
                borrowedCopies = parseInt(borrowedCopies);
                if (isNaN(borrowedCopies) || borrowedCopies < 0) {
                    alert("Borrowed copies must be a valid non-negative number");
                    return
                }
                let borrowedCount = prompt("Enter the initial borrowed count (popularity metric):");
                if (borrowedCount === null || borrowedCount === "") {
                    alert("Borrowed count cannot be empty");
                    return
                }
                borrowedCount = parseInt(borrowedCount);
                if (isNaN(borrowedCount) || borrowedCount < 0) {
                    alert("Borrowed count must be a valid non-negative number");
                    return
                }
                let book = {
                    bookName: bookName,
                    authorName: authorName,
                    availableCopies: availableCopies,
                    borrowedCopies: borrowedCopies,
                    borrowedCount: borrowedCount
                };
                books.push(book);
                alert("Book added successfully")
            }

            function borrowBook() {
                let toBorrowList = ""
                for (let i = 0; i < books.length; i++) {
                    toBorrowList += `${i+1}. ${books[i].bookName} by ${books[i].authorName} (${books[i].availableCopies} available)\n`;
                }

                let bookToBorrow = prompt(`${toBorrowList}\n\nEnter the number of the book you want to borrow:`);
                if (bookToBorrow === null || bookToBorrow === "") {
                    alert("Book number cannot be empty");
                    return
                }
                bookToBorrow = parseInt(bookToBorrow);
                if (isNaN(bookToBorrow) || bookToBorrow < 1 || bookToBorrow > books.length || books[bookToBorrow-1].availableCopies === 0) {
                    alert("Invalid book number or no copies available");
                    return
                }
                books[bookToBorrow-1].availableCopies--
                books[bookToBorrow-1].borrowedCopies++
                books[bookToBorrow-1].borrowedCount++
                alert("Book borrowed successfully")
            }

            function returnBook() {
                let toReturnList = ""
                for (let i = 0; i < books.length; i++) {
                    toReturnList += `${i+1}. ${books[i].bookName} by ${books[i].authorName} (${books[i].borrowedCopies} borrowed)\n`;
                }

                let bookToReturn = prompt(`${toReturnList}\n\nEnter the number of the book you want to return:`);
                if (bookToReturn === null || bookToReturn === "") {
                    alert("Book number cannot be empty");
                    return
                }
                bookToReturn = parseInt(bookToReturn);
                if (isNaN(bookToReturn) || bookToReturn < 1 || bookToReturn > books.length || books[bookToReturn-1].borrowedCopies === 0) {
                    alert("Invalid book number or no borrowed copies");
                    return
                }
                books[bookToReturn-1].availableCopies++
                books[bookToReturn-1].borrowedCopies--
                alert("Book returned successfully")
            }

            function calculateTotalBooks(){
                let totalAvailableCopies = 0
                let totalBorrowedCopies = 0
                for (let i = 0; i < books.length; i++) {
                    totalAvailableCopies += books[i].availableCopies
                    totalBorrowedCopies += books[i].borrowedCopies
                }
                return totalAvailableCopies + totalBorrowedCopies
            }

            function showReport(){
                let report = ""
                for (let i = 0; i < books.length; i++) {
                    report += `${books[i].bookName} by ${books[i].authorName}\n`;
                    report += ` - Available: ${books[i].availableCopies}, Borrowed: ${books[i].borrowedCopies}\n`;
                    report += ` - Total times borrowed (popularity): ${books[i].borrowedCount}\n\n`;
                }
                report += `Total books: ${calculateTotalBooks()}\n`;
                alert(report);
            }
    </script>
</body>
</html>